<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biogaz AI PRO — Eco Clean</title>
  <meta name="description" content="Biogaz AI PRO — dashboard, AI doradca i prognozy wydajności biogazowni. Styl: Eco Clean" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ========================
       Eco Clean design tokens
       ======================== */
    :root{
      --bg-light: #f5fbf6;
      --card-light: #ffffff;
      --muted-light: #4b6460;
      --accent-a: #2ea66b; /* główna zieleń */
      --accent-b: #66c19a; /* jasniejsza zieleń */
      --glass: rgba(15, 30, 23, 0.04);
      --glass-border: rgba(15, 30, 23, 0.06);
      --text-light: #072018;
      --soft-shadow: 0 8px 24px rgba(10, 30, 20, 0.06);
      --radius: 12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    [data-theme="dark"]{
      --bg-light: #07120f;
      --card-light: #0b1815;
      --muted-light: #9fbfb0;
      --accent-a: #1fc77a;
      --accent-b: #3bd39b;
      --glass: rgba(255,255,255,0.02);
      --glass-border: rgba(255,255,255,0.06);
      --text-light: #e6fff2;
      --soft-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(800px 300px at 10% 85%, rgba(102,193,154,0.05), transparent 10%), var(--bg-light);
      color:var(--text-light);
      padding:20px; display:flex; justify-content:center; font-size:14px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Loader (full screen) */
    #loader {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
      background: linear-gradient(135deg, rgba(46,166,107,0.95), rgba(102,193,154,0.95));
      color:white; z-index:9999; transition:opacity .6s ease, visibility .6s ease;
      font-family: Inter, sans-serif;
    }
    #loader.hidden { opacity:0; visibility:hidden; pointer-events:none; }
    .loader-logo { width:120px; height:120px; display:grid; place-items:center; border-radius:20px; background:rgba(255,255,255,0.08); box-shadow:0 14px 40px rgba(0,0,0,0.2); transform-origin:center; animation:logoBounce 1.2s ease-in-out infinite; }
    @keyframes logoBounce { 0%{transform:translateY(0)} 50%{transform:translateY(-8px)} 100%{transform:translateY(0)} }
    .loader-title { font-weight:700; margin-top:12px; font-size:20px; }
    .loader-sub { margin-top:6px; opacity:0.95; }

    /* container */
    .container{
      width:1200px; max-width:100%; display:grid; grid-template-columns:320px 1fr; gap:18px; align-items:start;
      transition:opacity .8s ease, transform .5s ease; opacity:0; transform:translateY(6px);
    }
    .container.ready { opacity:1; transform:none; }

    header{ grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:12px }
    .brand { display:flex; gap:12px; align-items:center }
    .svg-logo { width:56px; height:56px; background: linear-gradient(135deg,var(--accent-a),var(--accent-b)); border-radius:14px; display:grid; place-items:center; color:white; box-shadow:var(--soft-shadow) }
    h1{ margin:0; font-size:18px; }
    .subtitle{ color:var(--muted-light); font-size:13px; margin:0 }

    /* card */
    .card { background:var(--card-light); border-radius:var(--radius); padding:14px; border:1px solid var(--glass-border); box-shadow:var(--soft-shadow) }
    label{ display:block; color:var(--muted-light); margin-bottom:6px; font-size:13px }
    input[type=number], select, input[type=range], textarea, input[type=text]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--text-light)
    }

    .row{ display:flex; gap:10px }
    .btn { padding:10px 14px; border-radius:10px; border:0; font-weight:700; cursor:pointer; box-shadow: 0 6px 18px rgba(15,45,30,0.06); transition: transform .12s ease, box-shadow .12s }
    .btn:active { transform:translateY(1px) }
    .btn-glow { background: linear-gradient(90deg, var(--accent-a), var(--accent-b)); color:white; box-shadow: 0 8px 28px rgba(46,166,107,0.12); border:1px solid rgba(255,255,255,0.03) }
    .btn-ghost { background:transparent; border:1px solid var(--glass-border); color:var(--muted-light) }

    /* Dashboard */
    main { display:flex; flex-direction:column; gap:14px }
    .dashboard { display:grid; grid-template-columns:1fr 380px; gap:14px }
    .metrics { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:10px }
    .metric { padding:12px; border-radius:10px; text-align:center; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid var(--glass-border) }
    .metric .label { color:var(--muted-light); font-size:13px }
    .metric .value { font-weight:800; font-size:18px; margin-top:8px }

    .charts { display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
    canvas { background:transparent; border-radius:8px; width:100% !important; height:140px !important; }

    .right-panel { display:flex; flex-direction:column; gap:10px }

    /* Chat */
    .chat { display:flex; flex-direction:column; gap:8px; height:300px; overflow:auto; padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid var(--glass-border) }
    .msg { padding:8px 10px; border-radius:10px; max-width:85%; line-height:1.4; font-size:14px }
    .msg.user { align-self:flex-end; background:linear-gradient(90deg, rgba(46,166,107,0.12), rgba(102,193,154,0.08)); color:var(--text-light) }
    .msg.bot { align-self:flex-start; background:linear-gradient(90deg, rgba(15,30,23,0.03), rgba(15,30,23,0.02)); color:var(--text-light) }

    .toolbar { display:flex; gap:8px; align-items:center }
    .tag { padding:6px 8px; border-radius:8px; border:1px solid var(--glass-border); color:var(--muted-light) }

    footer { grid-column:1/-1; text-align:center; color:var(--muted-light); font-size:13px; padding:10px 0 }

    /* Settings panel */
    .settings-row { display:flex; gap:8px; align-items:center; margin-top:8px }
    .small { width:96px }

    /* responsive */
    @media (max-width:1000px){
      .container { grid-template-columns: 1fr; padding:10px }
      .dashboard { grid-template-columns: 1fr }
      .charts { grid-template-columns: 1fr }
      .metrics { grid-template-columns: repeat(2,1fr) }
    }
    @media (max-width:600px){
      body { padding:10px }
      .svg-logo { width:48px; height:48px }
      h1 { font-size:16px }
    }
  </style>
</head>
<body>
  <!-- LOADER -->
  <div id="loader" role="status" aria-label="Ładowanie aplikacji">
    <div class="loader-logo" aria-hidden>
      <!-- SVG animated eco logo -->
      <svg width="72" height="72" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
        <defs>
          <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="white" stop-opacity="0.95"/>
            <stop offset="1" stop-color="white" stop-opacity="0.7"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="64" height="64" rx="12" fill="url(#g1)" opacity="0.06"/>
        <g transform="translate(12,12)">
          <path d="M20 0C11.1634 0 4 7.16344 4 16C4 24.8366 11.1634 32 20 32C28.8366 32 36 24.8366 36 16C36 7.16344 28.8366 0 20 0Z" fill="white"/>
          <path d="M8 28C8 20 14 15 20 15C26 15 32 20 32 28" fill="#2ea66b" opacity="0.95"/>
        </g>
      </svg>
    </div>
    <div class="loader-title">Biogaz AI PRO</div>
    <div class="loader-sub">Initializing AI Engine... (frontend demo)</div>
  </div>

  <!-- MAIN APP -->
  <div class="container" id="app" data-theme="light">
    <header>
      <div class="brand">
        <div class="svg-logo" aria-hidden>
          <!-- small svg icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
            <path d="M12 2C9.23858 8 6 9 6 13C6 16 8 20 12 20C16 20 18 16 18 13C18 9 14.7614 8 12 2Z" fill="white"/>
            <path d="M3 22C4.5 17 8 14 12 14C16 14 19.5 17 21 22" stroke="rgba(255,255,255,0.85)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h1>Biogaz AI PRO</h1>
          <p class="subtitle">Optymalizacja substratu — Eco Clean edition</p>
        </div>
      </div>

      <div class="toolbar">
        <div class="tag" id="timeTag" aria-live="polite">--</div>
        <div class="tag" id="modeTag">Tryb: <span id="dayNight">Dzień</span></div>
        <button class="btn btn-ghost" id="themeToggle" title="Przełącz motyw">Tryb nocny</button>
        <button class="btn btn-ghost" id="openSettings">Ustawienia</button>
      </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="card" aria-label="Panel parametrów">
      <h3>Parametry substratu</h3>

      <label for="type">Rodzaj</label>
      <select id="type" aria-label="Rodzaj substratu">
        <option>Kiszonka kukurydzy</option>
        <option>Obornik świński</option>
        <option>Odpady spożywcze</option>
        <option>Mieszanka</option>
      </select>

      <label for="share">Udział (%)</label>
      <input id="share" type="number" value="50" min="0" max="100" />

      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label for="sm">SM (%)</label>
          <input id="sm" type="number" value="25" step="0.1" />
        </div>
        <div style="flex:1">
          <label for="vs">VS (%)</label>
          <input id="vs" type="number" value="88" step="0.1" />
        </div>
      </div>

      <label for="cn" style="margin-top:8px">C/N</label>
      <input id="cn" type="number" value="24" step="0.1" />

      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label for="ph">pH</label>
          <input id="ph" type="number" value="7.0" step="0.05" />
        </div>
        <div style="flex:1">
          <label for="temp">Temp (°C)</label>
          <input id="temp" type="number" value="38" step="0.1" />
        </div>
      </div>

      <label for="olr" style="margin-top:8px">OLR (kg VS/m³·d)</label>
      <input id="olr" type="number" value="2.3" step="0.01" />

      <hr style="border:none;border-top:1px solid var(--glass-border);margin:12px 0" />

      <h4>Tryb zaawansowany</h4>
      <label for="mode">Tryb pracy</label>
      <select id="mode">
        <option value="mezofilny">Mezofilny (≈37–39°C)</option>
        <option value="termofilny">Termofilny (≈53–55°C)</option>
      </select>

      <label for="goal" style="margin-top:8px">Cel optymalizacji</label>
      <select id="goal">
        <option value="wydajnosc">Maksymalna wydajność</option>
        <option value="koszt">Minimalny koszt</option>
      </select>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-glow" id="runBtn" aria-label="Uruchom symulację">Uruchom</button>
        <button class="btn btn-ghost" id="saveBtn" aria-label="Zapisz bieżące ustawienia">Zapisz</button>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-ghost" id="exportCsv">Eksport CSV</button>
        <button class="btn btn-ghost" id="exportJson">Eksport JSON</button>
      </div>

      <!-- Settings drawer minimal -->
      <div id="settingsDrawer" style="display:none;margin-top:12px">
        <h4>Ustawienia</h4>
        <label for="lang">Język</label>
        <select id="lang"><option value="pl">Polski</option><option value="en">English</option></select>

        <label style="margin-top:8px">Jednostki</label>
        <div class="settings-row"><select id="units" class="small"><option value="metric">m³/kg VS</option><option value="imperial">ft³/lb</option></select><div style="flex:1"></div></div>

        <label style="margin-top:8px">Styl wykresów</label>
        <select id="chartStyle"><option value="line">Linia</option><option value="area">Obszar</option></select>

        <div style="margin-top:8px"><button class="btn btn-glow" id="applySettings">Zastosuj</button></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main>
      <section class="card dashboard" aria-label="Dashboard">
        <div>
          <div class="metrics" role="list">
            <div class="metric" role="listitem"><div class="label">CH₄ (%)</div><div class="value" id="methaneVal">—</div></div>
            <div class="metric" role="listitem"><div class="label">Biogaz (m³/d)</div><div class="value" id="biogasVal">—</div></div>
            <div class="metric" role="listitem"><div class="label">Wydajność</div><div class="value" id="effVal">—</div></div>
          </div>

          <div class="charts" aria-hidden="false">
            <canvas id="ch4Chart"></canvas>
            <canvas id="biogasChart"></canvas>
            <canvas id="phChart"></canvas>
            <canvas id="tempChart"></canvas>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <div class="tag">Filtr:</div>
            <button class="btn btn-ghost" id="filter24">24h</button>
            <button class="btn btn-ghost" id="filter7d">7 dni</button>
            <button class="btn btn-ghost" id="filterAll">Wszystko</button>
            <div style="flex:1"></div>
            <div class="tag" id="forecastTag">Prognoza (7d): —</div>
          </div>
        </div>

        <aside class="right-panel" aria-label="Panel prawy">
          <div class="card" style="padding:10px">
            <h4>AI Advisor</h4>
            <div class="chat" id="chat" aria-live="polite"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="chatInput" placeholder="Napisz: 'co zmienić?'" aria-label="Pole czatu" />
              <button class="btn btn-glow" id="chatSend">Wyślij</button>
            </div>
          </div>

          <div class="card" style="padding:10px">
            <h4>Historia</h4>
            <div id="historyList" style="max-height:140px;overflow:auto"></div>
            <div style="margin-top:8px;display:flex;gap:6px">
              <button class="btn btn-ghost" id="loadLast">Wczytaj ostatni</button>
              <button class="btn btn-ghost" id="deleteLast">Usuń ostatni</button>
            </div>
          </div>
        </aside>
      </section>

      <footer>© 2025 Biogaz AI PRO — Eco Clean • Frontend demo</footer>
    </main>
  </div>

  <script>
    /******************************************************************
     * Biogaz AI PRO - Frontend-only logic
     * - loader + auto day/night theme
     * - charts (Chart.js)
     * - heuristic predictor (client-side)
     * - localStorage history, export CSV/JSON
     * - AI Advisor (rule-based) with typing indicator
     * - settings drawer (language, units, chart style)
     ******************************************************************/

    // ---------- Utilities ----------
    const nowTag = document.getElementById('timeTag');
    function updateTime(){ nowTag.textContent = new Date().toLocaleString('pl-PL'); }
    setInterval(updateTime, 60000);
    updateTime();

    // Auto day/night: day 7:00-19:00 -> light, else dark
    (function setAutoTheme(){
      const h = new Date().getHours();
      const app = document.getElementById('app');
      const dayNightLabel = document.getElementById('dayNight');
      if(h >= 7 && h < 19){ app.setAttribute('data-theme','light'); dayNightLabel.textContent = 'Dzień'; document.getElementById('themeToggle').textContent = 'Tryb nocny'; }
      else { app.setAttribute('data-theme','dark'); dayNightLabel.textContent = 'Noc'; document.getElementById('themeToggle').textContent = 'Tryb dzienny'; }
    })();

    // Remove loader after init
    window.addEventListener('load', ()=> {
      setTimeout(()=> {
        const loader = document.getElementById('loader');
        loader.classList.add('hidden');
        document.querySelector('.container').classList.add('ready');
      }, 1400); // loader visible briefly
    });

    // ---------- Elements & storage ----------
    const STORAGE_KEY = 'biogaz_ai_history_v2';
    let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    const el = {
      type: document.getElementById('type'),
      share: document.getElementById('share'),
      sm: document.getElementById('sm'),
      vs: document.getElementById('vs'),
      cn: document.getElementById('cn'),
      ph: document.getElementById('ph'),
      temp: document.getElementById('temp'),
      olr: document.getElementById('olr'),
      mode: document.getElementById('mode'),
      goal: document.getElementById('goal'),
      runBtn: document.getElementById('runBtn'),
      saveBtn: document.getElementById('saveBtn'),
      exportCsv: document.getElementById('exportCsv'),
      exportJson: document.getElementById('exportJson'),
      methaneVal: document.getElementById('methaneVal'),
      biogasVal: document.getElementById('biogasVal'),
      effVal: document.getElementById('effVal'),
      historyList: document.getElementById('historyList'),
      loadLast: document.getElementById('loadLast'),
      deleteLast: document.getElementById('deleteLast'),
      chat: document.getElementById('chat'),
      chatInput: document.getElementById('chatInput'),
      chatSend: document.getElementById('chatSend'),
      themeToggle: document.getElementById('themeToggle'),
      openSettings: document.getElementById('openSettings'),
      settingsDrawer: document.getElementById('settingsDrawer'),
      applySettings: document.getElementById('applySettings'),
      lang: document.getElementById('lang'),
      units: document.getElementById('units'),
      chartStyle: document.getElementById('chartStyle'),
      filter24: document.getElementById('filter24'),
      filter7d: document.getElementById('filter7d'),
      filterAll: document.getElementById('filterAll'),
      forecastTag: document.getElementById('forecastTag')
    };

    // ---------- Charts setup ----------
    function chartFactory(ctx, label){
      return new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label, data: [], tension: 0.3, fill: false }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: 'rgba(0,0,0,0.5)' } },
            y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: 'rgba(0,0,0,0.6)' } }
          }
        }
      });
    }

    const ch4Chart = chartFactory(document.getElementById('ch4Chart').getContext('2d'), 'CH₄ %');
    const biogasChart = chartFactory(document.getElementById('biogasChart').getContext('2d'), 'Biogaz m³/d');
    const phChart = chartFactory(document.getElementById('phChart').getContext('2d'), 'pH');
    const tempChart = chartFactory(document.getElementById('tempChart').getContext('2d'), 'Temp °C');

    // Push a point to charts
    function pushPoint(ts, point){
      const tLabel = new Date(ts).toLocaleTimeString();
      const push = (chart, value) => {
        chart.data.labels.push(tLabel);
        chart.data.datasets[0].data.push(value);
        if(chart.data.labels.length > 48){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
        chart.update();
      };
      push(ch4Chart, point.methanePercent);
      push(biogasChart, point.biogasM3);
      push(phChart, point.ph);
      push(tempChart, point.temp);
    }

    // ---------- Heuristic predictor ----------
    function predict(inputs){
      // inputs: object with fields from UI
      const baseMap = {
        "Kiszonka kukurydzy": 0.55,
        "Obornik świński": 0.6,
        "Odpady spożywcze": 0.65,
        "Mieszanka": 0.58
      };
      const base = baseMap[inputs.type] || 0.55;
      const vsFactor = Math.min(1.35, inputs.vs / 80);
      const moistureFactor = 1 - Math.abs(inputs.sm - 25) / 60; // best near 25%
      const cnFactor = 1 - Math.min(0.5, Math.abs(inputs.cn - 25) / 60);
      const phFactor = 1 - Math.min(0.6, Math.abs(inputs.ph - 7.1) / 2.2);
      const tempTarget = inputs.mode === 'termofilny' ? 55 : 38;
      const tempFactor = 1 - Math.min(0.6, Math.abs(inputs.temp - tempTarget) / 30);
      const olrFactor = 1 - Math.max(0, (inputs.olr - 3) / 6);
      const methaneFraction = Math.max(0.33, base * vsFactor * moistureFactor * cnFactor * phFactor * tempFactor * olrFactor);
      const biogas = Math.max(60, (inputs.vs * inputs.share / 100) * (inputs.sm / 100) * 1100 * olrFactor);
      const eff = +(methaneFraction * 0.8).toFixed(3);
      return { methanePercent: +(methaneFraction * 100).toFixed(1), biogasM3: Math.round(biogas), eff };
    }

    // Get current inputs
    function currentInputs(){
      return {
        type: el.type.value,
        share: +el.share.value,
        sm: +el.sm.value,
        vs: +el.vs.value,
        cn: +el.cn.value,
        ph: +el.ph.value,
        temp: +el.temp.value,
        olr: +el.olr.value,
        mode: el.mode.value,
        goal: el.goal.value
      };
    }

    // ---------- History UI ----------
    function renderHistory(){
      el.historyList.innerHTML = '';
      if(history.length === 0){ el.historyList.innerHTML = '<div style="color:var(--muted-light)">Brak zapisanych symulacji</div>'; return; }
      history.slice().reverse().forEach((h, idx) => {
        const item = document.createElement('div');
        item.style.padding = '8px 6px';
        item.style.borderBottom = '1px dashed var(--glass-border)';
        item.style.fontSize = '13px';
        item.innerHTML = `<strong>${h.type}</strong> • ${h.share}% • CH₄: ${h.methanePercent}% • ${h.biogasM3} m³/d<br><span style="font-size:12px;color:var(--muted-light)">${new Date(h.time).toLocaleString()}</span>`;
        el.historyList.appendChild(item);
      });
    }

    // Save to localStorage
    function persist(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      renderHistory();
    }

    // ---------- Forecast (simple linear trend on last points) ----------
    function forecastDays(days=7){
      if(history.length < 3) return null;
      const pts = history.slice(-12);
      const xs = pts.map((p, i) => i);
      const ys = pts.map(p => p.methanePercent);
      const n = xs.length;
      const xBar = xs.reduce((a,b)=>a+b,0)/n;
      const yBar = ys.reduce((a,b)=>a+b,0)/n;
      let num = 0, den = 0;
      for(let i=0;i<n;i++){ num += (xs[i]-xBar)*(ys[i]-yBar); den += (xs[i]-xBar)*(xs[i]-xBar); }
      const slope = den === 0 ? 0 : num / den;
      const intercept = yBar - slope * xBar;
      const preds = [];
      for(let d=1; d<=days; d++){ const x = n - 1 + d; const y = intercept + slope * x; preds.push(Math.max(0, +y.toFixed(2))); }
      return preds;
    }

    function updateForecastTag(){
      const preds = forecastDays(7);
      if(!preds){ el.forecastTag.textContent = 'Prognoza (7d): brak danych'; return; }
      const avg = (preds.reduce((a,b)=>a+b,0)/preds.length).toFixed(2);
      el.forecastTag.textContent = `Prognoza CH₄ (7d avg): ${avg} %`;
    }

    // ---------- AI Advisor (rule-based) with typing sim ----------
    function aiAdvisorResponse(query, inputs){
      const q = query.toLowerCase();
      const suggestions = [];
      if(inputs.cn < 22) suggestions.push('C/N < 22 — dodaj substrat bogaty w węgiel (np. słoma, kiszonka).');
      if(inputs.ph < 6.8) suggestions.push('pH niskie — rozważ alkalizację lub rozcieńczenie.');
      if(inputs.ph > 8.0) suggestions.push('pH wysokie — sprawdź źródła zasadowości.');
      if(inputs.olr > 3.0) suggestions.push('OLR wysokie — zmniejsz dopływ lub wydłuż HRT.');
      if(inputs.vs < 70) suggestions.push('Niska zawartość VS — dodaj odpady spożywcze dla lepszej wydajności.');
      if(suggestions.length === 0) suggestions.push('Dane wyglądają stabilnie — monitoruj VFA i NH₃.');

      if(q.includes('ph')) return 'pH: utrzymuj 6.8–7.5. Sprawdź VFA jeśli pH spada.';
      if(q.includes('cn')) return 'C/N: celuj ~25. Dodatek materiału węglowego poprawi balans.';
      if(q.includes('olr')) return 'OLR: unikaj skoków >3 kg VS/m³·d. Wprowadzaj zmiany stopniowo.';
      if(q.includes('co zmienić')||q.includes('porad')||q.includes('jak')) return suggestions.join(' ');
      return suggestions.join(' ');
    }

    // Add message with typing indicator
    function addUserMessage(text){
      const div = document.createElement('div'); div.className = 'msg user'; div.textContent = text;
      el.chat.appendChild(div); el.chat.scrollTop = el.chat.scrollHeight;
    }
    function addBotMessage(text){
      const div = document.createElement('div'); div.className = 'msg bot'; div.textContent = text;
      el.chat.appendChild(div); el.chat.scrollTop = el.chat.scrollHeight;
    }

    function botTypingThenReply(q, inputs){
      // show typing indicator
      const typing = document.createElement('div'); typing.className = 'msg bot'; typing.textContent = 'AI pisze...';
      el.chat.appendChild(typing); el.chat.scrollTop = el.chat.scrollHeight;
      const delay = 800 + Math.random()*900;
      setTimeout(()=> {
        typing.remove();
        const reply = aiAdvisorResponse(q, inputs);
        addBotMessage(reply);
      }, delay);
    }

    // ---------- Event bindings ----------
    el.runBtn.addEventListener('click', ()=> {
      const inputs = currentInputs();
      const res = predict(inputs);
      const entry = { ...inputs, ...res, time: new Date().toISOString() };
      // update UI
      el.methaneVal.textContent = res.methanePercent + ' %';
      el.biogasVal.textContent = res.biogasM3 + ' m³/d';
      el.effVal.textContent = res.eff + ' m³/kgVS';
      // push chart & history
      pushPoint(entry.time, entry);
      history.push(entry);
      persist();
      updateForecastTag();
      // small bot hint
      botTypingThenReply('Automatyczna analiza', inputs);
    });

    el.saveBtn.addEventListener('click', ()=> {
      if(history.length === 0) return alert('Brak danych do zapisania. Najpierw uruchom symulację.');
      persist();
      alert('Zapisano lokalnie.');
    });

    el.exportCsv.addEventListener('click', ()=> {
      if(history.length === 0) return alert('Brak danych do eksportu.');
      const keys = ['time','type','share','sm','vs','cn','ph','temp','olr','methanePercent','biogasM3','eff'];
      const rows = [keys.join(',')];
      history.forEach(h => {
        rows.push(keys.map(k => `"${(h[k]===undefined?'':h[k])}"`).join(','));
      });
      const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'biogaz_history.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    el.exportJson.addEventListener('click', ()=> {
      if(history.length === 0) return alert('Brak danych do eksportu.');
      const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'biogaz_history.json'; a.click();
      URL.revokeObjectURL(url);
    });

    el.loadLast.addEventListener('click', ()=> {
      if(history.length === 0) return alert('Brak zapisanych danych.');
      const last = history[history.length - 1];
      const keys = ['type','share','sm','vs','cn','ph','temp','olr','mode','goal'];
      keys.forEach(k => { if(last[k] !== undefined && document.getElementById(k)) document.getElementById(k).value = last[k]; });
      alert('Wczytano ostatni zapis.');
    });

    el.deleteLast.addEventListener('click', ()=> {
      if(history.length === 0) return alert('Brak zapisanych danych.');
      if(!confirm('Usunąć ostatni zapis?')) return;
      history.pop();
      persist();
      // also remove last points from charts (rebuild simply)
      rebuildChartsFromHistory();
    });

    // Chat send
    el.chatSend.addEventListener('click', ()=> {
      const q = el.chatInput.value.trim();
      if(!q) return;
      addUserMessage(q);
      el.chatInput.value = '';
      const inputs = currentInputs();
      botTypingThenReply(q, inputs);
    });

    // Keyboard: Enter sends in chat
    el.chatInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); el.chatSend.click(); } });

    // Theme toggle
    el.themeToggle.addEventListener('click', ()=> {
      const current = document.getElementById('app').getAttribute('data-theme');
      const next = current === 'light' ? 'dark' : 'light';
      document.getElementById('app').setAttribute('data-theme', next);
      document.getElementById('themeToggle').textContent = next === 'dark' ? 'Tryb dzienny' : 'Tryb nocny';
    });

    // Settings drawer open/close
    el.openSettings.addEventListener('click', ()=> {
      if(el.settingsDrawer.style.display === 'none' || el.settingsDrawer.style.display === '') {
        el.settingsDrawer.style.display = 'block';
      } else el.settingsDrawer.style.display = 'none';
    });

    el.applySettings.addEventListener('click', ()=> {
      alert('Ustawienia zastosowane. (Demo frontend - tylko UI)');
      el.settingsDrawer.style.display = 'none';
    });

    // Filters
    el.filter24.addEventListener('click', ()=> filterAndRedraw(24));
    el.filter7d.addEventListener('click', ()=> filterAndRedraw(24*7));
    el.filterAll.addEventListener('click', ()=> filterAndRedraw(null));

    function filterAndRedraw(hours){
      const cutoff = hours ? Date.now() - hours * 3600 * 1000 : 0;
      const filtered = hours ? history.filter(h => new Date(h.time).getTime() >= cutoff) : history.slice();
      [ch4Chart, biogasChart, phChart, tempChart].forEach(c => { c.data.labels = []; c.data.datasets[0].data = []; });
      filtered.forEach(h => pushPoint(h.time, h));
      // if no filtered points, leave empty
    }

    // ---------- Helper: rebuild charts from history ----------
    function rebuildChartsFromHistory(){
      [ch4Chart, biogasChart, phChart, tempChart].forEach(c => { c.data.labels = []; c.data.datasets[0].data = []; c.update(); });
      history.forEach(h => pushPoint(h.time, h));
      renderHistory();
      updateForecastTag();
    }

    // ---------- Forecast update interval ----------
    setInterval(updateForecastTag, 4000);

    // ---------- Initial render ----------
    function init(){
      // if any history, populate charts
      rebuildChartsFromHistory();
      // show a starter bot message
      addBotMessage('Witaj! Naciśnij "Uruchom", aby przeprowadzić symulację. Możesz też zapytać: "co zmienić?"');
      // apply physics: if day/night initial label update
      const appTheme = document.getElementById('app').getAttribute('data-theme');
      document.getElementById('themeToggle').textContent = appTheme === 'dark' ? 'Tryb dzienny' : 'Tryb nocny';
    }

    // Expose addBotMessage as function used above
    function addBotMessage(text){
      const div = document.createElement('div'); div.className = 'msg bot'; div.textContent = text;
      el.chat.appendChild(div); el.chat.scrollTop = el.chat.scrollHeight;
    }

    // Auto save to storage when page unloaded
    window.addEventListener('beforeunload', ()=> {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    });

    // Initialize
    init();

    /***************
     * Optional: You can add more features:
     * - real ML endpoint: fetch('/api/predict', {method:'POST', body: JSON.stringify(inputs)})
     * - richer charts (colors, area fills, multi-axis)
     * - user auth and server-side DB
     ***************/
  </script>
</body>
</html>
